package com.jcondotta.bankaccounts.notification;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.jcondotta.bankaccounts.contracts.open.BankAccountOpenedIntegrationEvent;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
@Slf4j
public class BankAccountOpenedEventListener {

  private final ObjectMapper objectMapper;
  private final SendBankAccountOpenedNotificationUseCase useCase;

  @KafkaListener(
    topics = "bank-account-opened",
    groupId = "bank-accounts-notifications"
  )
  public void handle(BankAccountOpenedIntegrationEvent integrationEvent) throws JsonProcessingException {

    log.info("Received raw message: {}", integrationEvent);



//    JavaType envelopeType = objectMapper
//      .getTypeFactory()
//      .constructParametricType(
//        EventEnvelope.class,
//        BankAccountOpenedEvent.class
//      );
//
//    EventEnvelope<BankAccountOpenedEvent> envelope =
//      objectMapper.readValue(rawMessage, envelopeType);


    useCase.execute(integrationEvent.payload());
  }

}
