package com.jcondotta.bankaccounts.domain.entities;

import com.jcondotta.bankaccounts.domain.arguments_provider.AccountTypeAndCurrencyArgumentsProvider;
import com.jcondotta.bankaccounts.domain.enums.AccountType;
import com.jcondotta.bankaccounts.domain.enums.Currency;
import com.jcondotta.bankaccounts.domain.events.BankAccountOpenedEvent;
import com.jcondotta.bankaccounts.domain.fixtures.AccountHolderFixtures;
import com.jcondotta.bankaccounts.domain.fixtures.BankAccountTestFixture;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ArgumentsSource;

import static org.assertj.core.api.Assertions.assertThat;

class BankAccountOpenTest {

  private static final AccountHolderFixtures PRIMARY_ACCOUNT_HOLDER = AccountHolderFixtures.JEFFERSON;

  @ParameterizedTest
  @ArgumentsSource(AccountTypeAndCurrencyArgumentsProvider.class)
  void shouldOpenBankAccountWithPrimaryHolder_whenValidDataProvided(AccountType accountType, Currency currency) {
    var bankAccount = BankAccountTestFixture.openPendingAccount(PRIMARY_ACCOUNT_HOLDER, accountType, currency);

    assertThat(bankAccount)
      .satisfies(account -> {
        assertThat(account.id()).isNotNull();
        assertThat(account.accountType()).isEqualTo(accountType);
        assertThat(account.currency()).isEqualTo(currency);
        assertThat(account.iban()).isEqualTo(BankAccountTestFixture.VALID_IBAN);
        assertThat(account.accountStatus()).isEqualTo(BankAccount.ACCOUNT_STATUS_ON_OPENING);
        assertThat(account.createdAt()).isNotNull();

        assertThat(account.accountHolders())
          .hasSize(1)
          .first()
          .satisfies(accountHolder -> {
            assertThat(accountHolder.id()).isNotNull();
            assertThat(accountHolder.name()).isEqualTo(PRIMARY_ACCOUNT_HOLDER.getAccountHolderName());
            assertThat(accountHolder.passportNumber()).isEqualTo(PRIMARY_ACCOUNT_HOLDER.getPassportNumber());
            assertThat(accountHolder.dateOfBirth()).isEqualTo(PRIMARY_ACCOUNT_HOLDER.getDateOfBirth());
            assertThat(accountHolder.email()).isEqualTo(PRIMARY_ACCOUNT_HOLDER.getEmail());
            assertThat(accountHolder.createdAt()).isNotNull();
            assertThat(accountHolder.isPrimary()).isTrue();
          });

        var domainEvents = bankAccount.pullDomainEvents();
        assertThat(domainEvents)
          .hasSize(1)
          .singleElement()
          .isInstanceOfSatisfying(BankAccountOpenedEvent.class, event -> {
            assertThat(event.eventId()).isNotNull();
            assertThat(event.bankAccountId()).isEqualTo(bankAccount.id());
            assertThat(event.accountType()).isEqualTo(accountType);
            assertThat(event.currency()).isEqualTo(currency);
            assertThat(event.primaryAccountHolderId()).isEqualTo(account.primaryAccountHolder().id());
            assertThat(event.occurredAt()).isNotNull();
          });
      });
  }
}